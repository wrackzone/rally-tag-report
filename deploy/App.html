<!DOCTYPE html>
<html>
<head>
    <title>rally-tag-report</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var that=this;Ext.create("Rally.data.WsapiDataStore",{model:"User",fetch:["ObjectID","DisplayName"],autoLoad:!0,listeners:{load:that._retrieveTags,scope:that}})},_retrieveTags:function(store,data){this.gUsers={};var that=this;console.log("userRecords: ",data),console.log("userStore: ",store),_.each(data,function(user){var userID=user.get("ObjectID");that.gUsers[userID]=user.get("DisplayName")}),Ext.create("Rally.data.WsapiDataStore",{model:"Tag",fetch:["Name"],autoLoad:!0,listeners:{load:that._retrieveArtifacts,scope:that}})},_retrieveArtifacts:function(store,data){this.gTags={};var that=this;_.each(data,function(tagRecord){var tagID=tagRecord.get("ObjectID");that.gTags[tagID]={Name:tagRecord.get("Name"),UsedIn:"",Creator:"",LastUsed:""},Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,listeners:{load:function(dataStore,records){var artifactIDs=[];_.each(records,function(artifactRecord){var id,artifactType=artifactRecord.get("_TypeHierarchy");"HierarchicalRequirement"==artifactType[artifactType.length-1]?id="US"+artifactRecord.get("_UnformattedID"):"Defect"==artifactType[artifactType.length-1]?id="DE"+artifactRecord.get("_UnformattedID"):"Task"==artifactType[artifactType.length-1]&&(id="TA"+artifactRecord.get("_UnformattedID")),_.contains(artifactIDs,id)||(""===that.gTags[tagID].UsedIn?that.gTags[tagID].UsedIn=id:that.gTags[tagID].UsedIn+=", "+id,artifactIDs.push(id))});var initialRecords=_.reject(records,function(record){return _.contains(record.data._PreviousValues.Tags,tagID)}),sortedRecords=_.sortBy(initialRecords,"_ValidFrom");that.gTags[tagID].LastUsed+=sortedRecords[sortedRecords.length-1].data._ValidFrom},scope:that},fetch:["_UnformattedID","Tags","_User","_TypeHierarchy","_PreviousValues"],hydrate:["_TypeHierarchy"],filters:[{property:"_TypeHierarchy",operator:"in",value:["Defect","Task","HierarchicalRequirement"]},{property:"Tags",value:tagID}],sorters:[{property:"_ValidFrom",direction:"ASC"}]})}),this._renderGrid()},_renderGrid:function(){this.add({xtype:"rallygrid",store:Ext.create("Rally.data.custom.Store",{data:_.toArray(this.gTags),pageSize:200}),columnCfgs:[{text:"Name",dataIndex:"Name"},{text:"Added By",dataIndex:"Creator"},{text:"Last Used",dataIndex:"LastUsed"},{text:"Associated Artifacts",dataIndex:"UsedIn",flex:1}]})}});

            Rally.launchApp('CustomApp', {
                name:"rally-tag-report",
	            parentRepos:"danallen88/release-defect-trend"
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
